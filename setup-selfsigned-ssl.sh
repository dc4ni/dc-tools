#!/usr/bin/expect -f

set timeout 60

puts "========================================="
puts "ç‚º IP åœ°å€å‰µå»ºè‡ªç°½å SSL æ†‘è­‰"
puts "=========================================\n"
puts "âš ï¸  æ³¨æ„: è‡ªç°½åæ†‘è­‰æœƒè¢«ç€è¦½å™¨æ¨™è¨˜ç‚ºã€Œä¸å®‰å…¨ã€"
puts "   å»ºè­°ç”¨æ–¼é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒ\n"

spawn ssh root@172.238.14.142
expect "password:"
send "@Joendle396\r"
expect "root@*"

send "cd /opt/directconverter\r"
expect "root@*"

# å‰µå»º SSL ç›®éŒ„
send "mkdir -p /etc/nginx/ssl\r"
expect "root@*"

# ç”Ÿæˆè‡ªç°½åæ†‘è­‰
send "openssl req -x509 -nodes -days 365 -newkey rsa:2048 \\\r"
expect ">"
send "-keyout /etc/nginx/ssl/selfsigned.key \\\r"
expect ">"
send "-out /etc/nginx/ssl/selfsigned.crt \\\r"
expect ">"
send "-subj '/C=TW/ST=Taiwan/L=Taipei/O=DirectConverter/CN=172.238.14.142'\r"
expect "root@*"

# å‚™ä»½åŸé…ç½®
send "cp /etc/nginx/sites-available/directconverter /etc/nginx/sites-available/directconverter.bak\r"
expect "root@*"

# æ›´æ–° Nginx é…ç½®æ·»åŠ  HTTPS
send "cat > /etc/nginx/sites-available/directconverter << 'EOF'\r"
expect ">"
send "# HTTP -> HTTPS é‡å®šå‘\r"
expect ">"
send "server {\r"
expect ">"
send "    listen 80;\r"
expect ">"
send "    server_name 172.238.14.142;\r"
expect ">"
send "    return 301 https://\$server_name\$request_uri;\r"
expect ">"
send "}\r"
expect ">"
send "\r"
expect ">"
send "# HTTPS é…ç½®\r"
expect ">"
send "server {\r"
expect ">"
send "    listen 443 ssl http2;\r"
expect ">"
send "    server_name 172.238.14.142;\r"
expect ">"
send "\r"
expect ">"
send "    ssl_certificate /etc/nginx/ssl/selfsigned.crt;\r"
expect ">"
send "    ssl_certificate_key /etc/nginx/ssl/selfsigned.key;\r"
expect ">"
send "    ssl_protocols TLSv1.2 TLSv1.3;\r"
expect ">"
send "    ssl_ciphers HIGH:!aNULL:!MD5;\r"
expect ">"
send "\r"
expect ">"
send "    client_max_body_size 50M;\r"
expect ">"
send "\r"
expect ">"
send "    # Frontend\r"
expect ">"
send "    location / {\r"
expect ">"
send "        proxy_pass http://localhost:3000;\r"
expect ">"
send "        proxy_http_version 1.1;\r"
expect ">"
send "        proxy_set_header Upgrade \$http_upgrade;\r"
expect ">"
send "        proxy_set_header Connection 'upgrade';\r"
expect ">"
send "        proxy_set_header Host \$host;\r"
expect ">"
send "        proxy_cache_bypass \$http_upgrade;\r"
expect ">"
send "        proxy_set_header X-Real-IP \$remote_addr;\r"
expect ">"
send "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\r"
expect ">"
send "        proxy_set_header X-Forwarded-Proto \$scheme;\r"
expect ">"
send "    }\r"
expect ">"
send "\r"
expect ">"
send "    # Backend API\r"
expect ">"
send "    location /api/ {\r"
expect ">"
send "        proxy_pass http://localhost:8000/api/;\r"
expect ">"
send "        proxy_http_version 1.1;\r"
expect ">"
send "        proxy_set_header Upgrade \$http_upgrade;\r"
expect ">"
send "        proxy_set_header Connection 'upgrade';\r"
expect ">"
send "        proxy_set_header Host \$host;\r"
expect ">"
send "        proxy_cache_bypass \$http_upgrade;\r"
expect ">"
send "        proxy_set_header X-Real-IP \$remote_addr;\r"
expect ">"
send "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\r"
expect ">"
send "        proxy_set_header X-Forwarded-Proto \$scheme;\r"
expect ">"
send "    }\r"
expect ">"
send "\r"
expect ">"
send "    # Backend æ–‡ä»¶ä¸‹è¼‰\r"
expect ">"
send "    location /download/ {\r"
expect ">"
send "        proxy_pass http://localhost:8000/download/;\r"
expect ">"
send "        proxy_http_version 1.1;\r"
expect ">"
send "        proxy_set_header Host \$host;\r"
expect ">"
send "        proxy_set_header X-Real-IP \$remote_addr;\r"
expect ">"
send "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\r"
expect ">"
send "    }\r"
expect ">"
send "}\r"
expect ">"
send "EOF\r"
expect "root@*"

send "nginx -t\r"
expect "root@*"
send "systemctl reload nginx\r"
expect "root@*"

send "echo '\n=== æ¸¬è©¦ HTTPS ==='\r"
expect "root@*"
send "curl -I -k https://172.238.14.142 2>&1 | head -5\r"
expect "root@*"

send "exit\r"
expect eof

puts "\n========================================="
puts "âœ… è‡ªç°½å SSL æ†‘è­‰å·²è¨­ç½®!"
puts "=========================================\n"
puts "ğŸŒ è¨ªå•ç¶²å€:"
puts "  â€¢ HTTPS: https://172.238.14.142"
puts "  â€¢ HTTP æœƒè‡ªå‹•é‡å®šå‘åˆ° HTTPS\n"
puts "âš ï¸  ç€è¦½å™¨è­¦å‘Š:"
puts "  é¦–æ¬¡è¨ªå•æ™‚,ç€è¦½å™¨æœƒé¡¯ç¤ºã€Œæ‚¨çš„é€£ç·šä¸å®‰å…¨ã€"
puts "  é€™æ˜¯æ­£å¸¸çš„,å› ç‚ºä½¿ç”¨è‡ªç°½åæ†‘è­‰"
puts "  é»æ“Šã€Œé€²éšã€->ã€Œç¹¼çºŒå‰å¾€ã€å³å¯\n"
puts "ğŸ’¡ å»ºè­°:"
puts "  ç”Ÿç”¢ç’°å¢ƒè«‹ä½¿ç”¨çœŸå¯¦åŸŸåå’Œ Let's Encrypt æ†‘è­‰"
puts "  åŸ·è¡Œ: ./setup-ssl.sh your-domain.com\n"
puts "=========================================\n"
